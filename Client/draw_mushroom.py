#!/usr/bin/python

############################################################
##                                                        ##
##                      FlipDots Maestro                  ##
##                   "Draw Mushroom FlipApp"              ##
##                                                        ##
##                  By Anthony K. Musgrove                ##
##            Senior Engineer of Labworx, Australia       ##
##                   (anthony@labworx.au)                 ##
##                                                        ##
##                  VER 1.0.0  [04/06/2023]               ##
##              RELEASED UNDER LICENCE GPL 3.0            ##
##                                                        ##
############################################################

import socket
import sys
import struct

maestro_server_ip, maestro_server_port = "localhost", 44000

opcode_display_light_pixel, opcode_display_dark_pixel, opcode_display_transparent_pixel = 0x0, 0x1, 0x2
opcode_display_pixel_with_colour, opcode_display_frame, opcode_send_uid, opcode_get_resolution = 0x3, 0x4, 0x5, 0x6

colour_code_dark, colour_code_light, colour_code_transparent = 0x0, 0x1, 0x2

connected_panel_width, connected_panel_height = 0, 0

comms_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

def get_packed_opcode(opcode):
    return struct.pack('>b', opcode)

def connect_to_panel():

    global comms_socket, maestro_server_ip, maestro_server_port
    comms_socket.connect((maestro_server_ip, maestro_server_port))

def get_panel_resolution():

    global comms_socket, connected_panel_width, connected_panel_height
    comms_socket.sendall(get_packed_opcode(opcode_get_resolution))
    
    resolution_raw_data = str(comms_socket.recv(1024), "utf-8")
            
    connected_panel_width = int(''.join(map(str, struct.unpack('>bbbb', bytes(resolution_raw_data[0:4], 'utf-8')))))
    connected_panel_height = int(''.join(map(str, struct.unpack('>bbbb', bytes(resolution_raw_data[4:8], 'utf-8')))))
    
def draw_frame(frame_data):
    global comms_socket

    print("Frame Data: " + str(frame_data))

    request_data = get_packed_opcode(opcode_display_frame) + frame_data
    comms_socket.sendall(request_data)


print("Connecting to maestro driver at: " + maestro_server_ip + ":" + str(maestro_server_port))
connect_to_panel()

print("Requesting panel resolution: .. ")
get_panel_resolution()

print("Connected panel resolution: " + str(connected_panel_width) + "x" + str(connected_panel_height))

if connected_panel_width != 16 and connected_panel_height != 16:
    print("This flipapp requires a panel with resolution 16x16!")
    exit(0)
 
mushroom_frame = bytearray([0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x1,0x2,0x0,0x0,0x2,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x2,0x2,0x2,0x0,0x0,0x2,0x2,0x2,0x1,0x1,0x0,0x0,0x0,0x0,0x1,0x0,0x2,0x2,0x0,0x0,0x0,0x0,0x2,0x2,0x0,0x1,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x0,0x1,0x1,0x2,0x2,0x0,0x0,0x2,0x2,0x2,0x2,0x0,0x0,0x2,0x2,0x1,0x1,0x1,0x2,0x2,0x2,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x2,0x2,0x2,0x1,0x1,0x2,0x2,0x2,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x2,0x2,0x2,0x1,0x1,0x2,0x2,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0x2,0x2,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x2,0x2,0x2,0x2,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x1,0x0,0x0,0x1,0x0,0x0,0x1,0x1,0x1,0x1,0x0,0x1,0x1,0x0,0x0,0x0,0x1,0x0,0x0,0x1,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x0])

draw_frame(mushroom_frame)
